<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper-schedule">

    <!-- 일정 저장 (scheduleNo 자동 생성 후 반환) -->
    <insert id="insertSchedule" parameterType="lx.project.dementia_care.vo.ScheduleVO" 
            useGeneratedKeys="true" keyProperty="scheduleNo" keyColumn="schedule_no">
        INSERT INTO schedule (schedule_title, content, schedule_date, start_time, end_time, user_no)
        VALUES (#{scheduleTitle}, #{content}, #{scheduleDate}, #{startTime}, #{endTime}, #{userNo})
    </insert>

    <!-- 일정 위치 저장 -->
    <insert id="insertScheduleLocation" parameterType="lx.project.dementia_care.vo.ScheduleLocationVO">
        INSERT INTO schedule_location (location_name, latitude, longitude, sequence_order, schedule_no)
        VALUES (#{locationName}, #{latitude}, #{longitude}, #{sequenceOrder}, #{scheduleNo})
    </insert>

    <!-- 경로 저장 -->
    <insert id="insertRoute" parameterType="lx.project.dementia_care.vo.RouteVO">
        INSERT INTO route (route_coordinates, buffer_coordinates, schedule_no)
        VALUES (#{routeCoordinates}::json, #{bufferCoordinates}::json, #{scheduleNo})
    </insert>

    <!-- 안심존 저장 -->
    <insert id="insertSafeZone" parameterType="lx.project.dementia_care.vo.SafeZoneVO">
        INSERT INTO safe_zone (zone_type, boundary_coordinates, user_no)
        VALUES (#{zoneType}, #{boundaryCoordinates}::json, #{userNo})
    </insert>

    <!-- 특정 사용자의 모든 일정 조회 -->
    <select id="getSchedulesByUserNo" parameterType="int" 
            resultType="lx.project.dementia_care.vo.ScheduleVO">
        SELECT schedule_no as scheduleNo, 
               schedule_title as scheduleTitle,
               content,
               schedule_date as scheduleDate,
               start_time as startTime,
               end_time as endTime,
               user_no as userNo
        FROM schedule
        WHERE user_no = #{userNo}
        ORDER BY schedule_date DESC, start_time DESC
    </select>

    <!-- 특정 일정의 위치 목록 조회 -->
    <select id="getLocationsByScheduleNo" parameterType="int" 
            resultType="lx.project.dementia_care.vo.ScheduleLocationVO">
        SELECT location_no as locationNo,
               location_name as locationName,
               latitude,
               longitude,
               sequence_order as sequenceOrder,
               schedule_no as scheduleNo
        FROM schedule_location
        WHERE schedule_no = #{scheduleNo}
        ORDER BY sequence_order
    </select>

    <!-- 특정 일정의 경로 조회 -->
    <select id="getRouteByScheduleNo" parameterType="int" 
            resultType="lx.project.dementia_care.vo.RouteVO">
        SELECT route_no as routeNo,
               route_coordinates as routeCoordinates,
               buffer_coordinates as bufferCoordinates,
               schedule_no as scheduleNo
        FROM route
        WHERE schedule_no = #{scheduleNo}
    </select>

    <!-- 특정 사용자의 모든 안심존 조회 -->
    <select id="getSafeZonesByUserNo" parameterType="int" 
            resultType="lx.project.dementia_care.vo.SafeZoneVO">
        SELECT safe_zone_no as safeZoneNo,
               zone_type as zoneType,
               boundary_coordinates as boundaryCoordinates,
               user_no as userNo
        FROM safe_zone
        WHERE user_no = #{userNo}
        ORDER BY safe_zone_no DESC
    </select>

    <!-- 특정 사용자의 특정 타입 안심존 조회 -->
    <select id="getSafeZonesByUserNoAndType" resultType="lx.project.dementia_care.vo.SafeZoneVO">
        SELECT safe_zone_no as safeZoneNo,
               zone_type as zoneType,
               boundary_coordinates as boundaryCoordinates,
               user_no as userNo
        FROM safe_zone
        WHERE user_no = #{userNo} AND zone_type = #{zoneType}
        ORDER BY safe_zone_no DESC
    </select>

    <!-- 현재 시간에 해당하는 일정 조회 (안심존 표시용) -->
    <select id="getCurrentSchedule" parameterType="int" 
            resultType="lx.project.dementia_care.vo.ScheduleVO">
        SELECT schedule_no as scheduleNo, 
               schedule_title as scheduleTitle,
               content,
               schedule_date as scheduleDate,
               start_time as startTime,
               end_time as endTime,
               user_no as userNo
        FROM schedule
        WHERE user_no = #{userNo}
          AND schedule_date = CURRENT_DATE
          AND start_time &lt;= CURRENT_TIME
          AND end_time &gt;= CURRENT_TIME
        LIMIT 1
    </select>

    <!-- 특정 일정 조회 (by scheduleNo) -->
    <select id="getScheduleByNo" parameterType="int" 
            resultType="lx.project.dementia_care.vo.ScheduleVO">
        SELECT schedule_no as scheduleNo, 
               schedule_title as scheduleTitle,
               content,
               schedule_date as scheduleDate,
               start_time as startTime,
               end_time as endTime,
               user_no as userNo
        FROM schedule
        WHERE schedule_no = #{scheduleNo}
    </select>

    <!-- 일정 수정 -->
    <update id="updateSchedule" parameterType="lx.project.dementia_care.vo.ScheduleVO">
        UPDATE schedule
        SET schedule_title = #{scheduleTitle},
            content = #{content},
            schedule_date = #{scheduleDate},
            start_time = #{startTime},
            end_time = #{endTime}
        WHERE schedule_no = #{scheduleNo}
    </update>

    <!-- 일정 삭제 -->
    <delete id="deleteSchedule" parameterType="int">
        DELETE FROM schedule
        WHERE schedule_no = #{scheduleNo}
    </delete>

    <!-- 특정 일정의 위치 삭제 -->
    <delete id="deleteScheduleLocations" parameterType="int">
        DELETE FROM schedule_location
        WHERE schedule_no = #{scheduleNo}
    </delete>

    <!-- 특정 일정의 경로 삭제 -->
    <delete id="deleteRoute" parameterType="int">
        DELETE FROM route
        WHERE schedule_no = #{scheduleNo}
    </delete>

    <!-- 특정 사용자의 경로형 안심존 삭제 -->
    <delete id="deleteSafeZoneByUserNo" parameterType="int">
        DELETE FROM safe_zone
        WHERE user_no = #{userNo} AND zone_type = '경로형'
    </delete>

    <!-- 안심존 수정 -->
    <update id="updateSafeZone" parameterType="lx.project.dementia_care.vo.SafeZoneVO">
        UPDATE safe_zone
        SET boundary_coordinates = #{boundaryCoordinates}::json
        WHERE safe_zone_no = #{safeZoneNo}
    </update>

    <!-- 경로 수정 (버퍼 좌표 업데이트) -->
    <update id="updateRoute" parameterType="lx.project.dementia_care.vo.RouteVO">
        UPDATE route
        SET buffer_coordinates = #{bufferCoordinates}::json
        WHERE schedule_no = #{scheduleNo}
    </update>

</mapper>

