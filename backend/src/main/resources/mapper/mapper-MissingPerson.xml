<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lx.project.dementia_care.mapper.MissingPersonMapper">

    <resultMap id="MissingPersonResultMap" type="lx.project.dementia_care.dto.MissingPersonDto">
        <id property="missingPostId" column="missing_post_id"/>
        <result property="patientUserNo" column="patient_user_no"/>
        <result property="reporterUserNo" column="reporter_user_no"/>
        <result property="photoPath" column="photo_path"/>
        <result property="description" column="description"/>
        <result property="reportedAt" column="reported_at"/>
        <result property="status" column="status"/>
        <result property="patientName" column="patient_name"/>
        <result property="patientBirthDate" column="birth_date"/>
        <result property="searchTogetherCount" column="search_together_count"/>
        <result property="currentUserJoined" column="currentUserJoined"/>
    </resultMap>

    <select id="findMissingUsers" resultType="lx.project.dementia_care.vo.UserVO">
        SELECT
            user_no AS userNo,
            user_id AS userId,
            name,
            birth_date AS birthDate,
            phone_number AS phoneNumber,
            user_status AS userStatus,
            profile_photo AS profilePhoto,
            role_no AS roleNo
        FROM users
        WHERE user_status = 1 
    </select>

    <!-- 실종자 정보를 불러오는 쿼리 -->
    <select id="findAllMissingPersons" resultMap="MissingPersonResultMap">
        SELECT
            mp.missing_post_id,
            mp.patient_user_no,
            mp.reporter_user_no,
            mp.photo_path,
            mp.description,
            mp.reported_at,
            mp.status,
            u.name AS patient_name,
            u.birth_date,
            (SELECT COUNT(*) FROM search_Together st WHERE st.missing_post_id = mp.missing_post_id) AS search_together_count
        FROM
            missing_post mp
        JOIN
            users u ON mp.patient_user_no = u.user_no
        WHERE
            mp.status = '실종'
        ORDER BY
            mp.reported_at DESC
    </select>

    <insert id="createMissingPersonReport" parameterType="lx.project.dementia_care.dto.MissingPersonDto">
        <selectKey keyProperty="missingPostId" resultType="int" order="AFTER">
            SELECT CURRVAL('missing_post_missing_post_id_seq') 
        </selectKey>
        INSERT INTO missing_post (
            patient_user_no, reporter_user_no, photo_path, 
            description, reported_at, status
        ) VALUES (
            #{patientUserNo}, #{reporterUserNo}, #{photoPath}, 
            #{description}, #{reportedAt}, #{status, jdbcType=VARCHAR, typeHandler=org.apache.ibatis.type.StringTypeHandler}
        )
    </insert>
    
    <update id="updateMissingStatus">
        UPDATE missing_post
        SET status = #{status}
        WHERE missing_post_id = #{missingPostId}
    </update>

    <select id="findLatestMissingReportByPatientNo" parameterType="map" resultMap="MissingPersonResultMap">
        SELECT
            mp.missing_post_id,
            mp.patient_user_no,
            mp.reporter_user_no,
            mp.photo_path,
            mp.description,
            mp.reported_at,
            mp.status,
            u.name AS patient_name,
            u.birth_date,
            (SELECT COUNT(*) FROM search_Together st WHERE st.missing_post_id = mp.missing_post_id) AS search_together_count,
            
            CASE 
                WHEN #{currentUserId} IS NULL THEN FALSE
                ELSE EXISTS (
                    SELECT 1 
                    FROM search_Together st 
                    WHERE st.missing_post_id = mp.missing_post_id 
                      AND st.user_id = #{currentUserId}
                )
            END AS currentUserJoined
            
        FROM
            missing_post mp
        JOIN
            users u ON mp.patient_user_no = u.user_no
        WHERE
            mp.patient_user_no = #{patientUserNo} 
            AND mp.status = '실종'
        ORDER BY
            mp.reported_at DESC
        LIMIT 1
    </select>

    <select id="findMissingReportById" parameterType="int" resultMap="MissingPersonResultMap">
        SELECT
            mp.missing_post_id,
            mp.patient_user_no,
            mp.reporter_user_no,
            mp.photo_path,
            mp.description,
            mp.reported_at,
            mp.status,
            u.name AS patient_name,
            u.birth_date,
            (SELECT COUNT(*) FROM search_Together st WHERE st.missing_post_id = mp.missing_post_id) AS search_together_count
        FROM
            missing_post mp
        JOIN
            users u ON mp.patient_user_no = u.user_no
        WHERE
            mp.missing_post_id = #{missingPostId}
    </select>

    <insert id="addSearchTogetherEntry" parameterType="map">
        INSERT INTO search_Together (missing_post_id, user_id)
        VALUES (#{missingPostId}, #{userId})
    </insert>

    <select id="findParticipantsByMissingPostId" parameterType="int" resultType="lx.project.dementia_care.vo.UserVO">
        SELECT
            u.user_no,
            u.user_id,
            u.name
        FROM
            users u
        JOIN
            search_Together st ON u.user_no = st.user_id
        WHERE
            st.missing_post_id = #{missingPostId}
    </select>

<!-- 실종자 감지 알림 -->
<select id="findLatestAlertForUser" parameterType="int" resultMap="MissingPersonResultMap">
        SELECT 
            mp.missing_post_id,
            mp.patient_user_no,
            mp.reported_at,
            u.name AS patient_name,
            u.birth_date 
        FROM 
            missing_post mp
        JOIN 
            users u ON mp.patient_user_no = u.user_no
        WHERE 
            mp.status = '실종'
            AND NOT EXISTS (
                SELECT 1
                FROM missing_alert_check mac
                WHERE mac.missing_post_id = mp.missing_post_id
                  AND mac.user_id = #{userId}
            )
        ORDER BY 
            mp.reported_at DESC
        LIMIT 1
    </select>

    <insert id="addAlertConfirmation" parameterType="map">
        INSERT INTO missing_alert_check (user_id, missing_post_id)
        VALUES (#{userId}, #{missingPostId})
        ON CONFLICT (user_id, missing_post_id) DO NOTHING
    </insert>

    <!-- 실종포스트 삭제 시 관련 데이터 삭제 -->
    <delete id="resolveActivePostsByPatientNo" parameterType="int">
        DELETE FROM missing_post
        WHERE patient_user_no = #{patientUserNo}
        AND status = '실종'
    </delete>

    <select id="findParticipantUserIds" parameterType="int" resultType="int">
        SELECT user_id 
        FROM search_Together 
        WHERE missing_post_id = #{missingPostId}
    </select>

</mapper>