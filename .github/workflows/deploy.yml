name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          cache-dependency-path: backend/pom.xml

      # Frontend 빌드
      - name: Install Frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: https://${{ secrets.DOMAIN }}
          VITE_FASTAPI_URL: https://${{ secrets.DOMAIN }}
          VITE_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          VITE_TMAP_API_KEY: ${{ secrets.TMAP_API_KEY }}
          VITE_VWORLD_API_KEY: ${{ secrets.VWORLD_API_KEY }}
          VITE_KAKAO_JS_KEY: ${{ secrets.KAKAO_JS_KEY }}
        run: npm run build

      # 서버에 배포
      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/final-project"
          strip_components: 0

      # 서버에서 배포 스크립트 실행
      - name: Run deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/final-project
            
            # 불필요한 파일/폴더 제거
            rm -rf .git node_modules .github *.md learning-pages-guide.txt text
            rm -rf python/venv python/__pycache__ python/cache
            rm -rf backend/target frontend/node_modules frontend/.env.*
            rm -rf backend/src/main/resources/application-local.properties
            
            # .env 파일 생성 (서버에만 존재)
            cat > .env << EOF
            # 데이터베이스 설정
            POSTGRES_DB=finalproject
            POSTGRES_USER=postgres
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            
            # 서비스 포트
            SPRING_SERVER_PORT=8080
            FASTAPI_PORT=8000
            
            # API 키
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            TMAP_API_KEY=${{ secrets.TMAP_API_KEY }}
            TMAP_API_BASE_URL=https://apis.openapi.sk.com/tmap
            
            # 도메인
            DOMAIN=${{ secrets.DOMAIN }}
            EOF
            
            # 업로드 디렉토리 생성
            mkdir -p backend/uploads/images backend/uploads/profiles
            
            # SSL 인증서 확인 및 복사 (호스트의 /etc/letsencrypt에서 프로젝트 디렉토리로)
            mkdir -p certbot/conf certbot/www
            if [ -d "/etc/letsencrypt/live/lx12mammamia.xyz" ]; then
              echo "호스트의 SSL 인증서를 프로젝트 디렉토리로 복사합니다."
              sudo cp -rL /etc/letsencrypt/live certbot/conf/ 2>/dev/null || sudo cp -r /etc/letsencrypt/live certbot/conf/ 2>/dev/null || echo "인증서 복사 실패, 기존 인증서 사용 시도"
              sudo cp -rL /etc/letsencrypt/archive certbot/conf/ 2>/dev/null || sudo cp -r /etc/letsencrypt/archive certbot/conf/ 2>/dev/null || true
              sudo chown -R $USER:$USER certbot/conf/ 2>/dev/null || true
            else
              echo "경고: /etc/letsencrypt/live/lx12mammamia.xyz 인증서를 찾을 수 없습니다."
              echo "인증서가 이미 certbot/conf에 있는지 확인합니다."
              if [ ! -d "certbot/conf/live/lx12mammamia.xyz" ]; then
                echo "인증서가 없습니다. nginx는 SSL 없이 시작할 수 없습니다."
              fi
            fi
            
            # Docker Compose 명령어 확인 (V2 또는 V1)
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker compose"
              echo "Docker Compose V2 사용"
            elif command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
              echo "Docker Compose V1 사용"
            else
              echo "Docker Compose를 찾을 수 없습니다. 설치가 필요합니다."
              exit 1
            fi
            
            # Docker Compose로 서비스 재시작
            $DOCKER_COMPOSE_CMD down || true
            
            # 데이터베이스 볼륨이 없으면 초기화 (첫 배포 시에만)
            if [ -z "$($DOCKER_COMPOSE_CMD ps -q postgres 2>/dev/null)" ] && [ -z "$(docker volume ls -q | grep postgres_data)" ]; then
              echo "데이터베이스 볼륨이 없습니다. 초기화를 진행합니다."
              $DOCKER_COMPOSE_CMD build --no-cache
              $DOCKER_COMPOSE_CMD up -d postgres
              echo "PostgreSQL 초기화 대기 중..."
              sleep 15
              $DOCKER_COMPOSE_CMD up -d
            else
              echo "기존 데이터베이스 볼륨이 있습니다. 재빌드만 진행합니다."
              $DOCKER_COMPOSE_CMD build --no-cache
              $DOCKER_COMPOSE_CMD up -d
            fi
            
            # 서비스 상태 확인
            sleep 10
            $DOCKER_COMPOSE_CMD ps
            $DOCKER_COMPOSE_CMD logs --tail=50 backend
            $DOCKER_COMPOSE_CMD logs --tail=50 fastapi
            $DOCKER_COMPOSE_CMD logs --tail=50 nginx

      # 배포 실패 시 알림
      - name: Check deployment status
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/final-project || true
            echo "::error::배포 실패! 서버 로그를 확인하세요."
            # Docker Compose 명령어 확인
            if command -v docker &> /dev/null && docker compose version &> /dev/null; then
              docker compose logs --tail=100 || echo "Docker Compose 로그를 가져올 수 없습니다."
            elif command -v docker-compose &> /dev/null; then
              docker-compose logs --tail=100 || echo "Docker Compose 로그를 가져올 수 없습니다."
            else
              echo "Docker Compose를 찾을 수 없습니다."
            fi
            exit 1
