-- === 기존 테이블이 존재할 경우 삭제 (FK 관계 고려하여 역순으로) ===
-- 자식 테이블부터 부모 테이블 순서로 삭제
DROP TABLE IF EXISTS sighting_report_comments CASCADE;
DROP TABLE IF EXISTS sighting_report CASCADE;
DROP TABLE IF EXISTS missing_alert_check CASCADE;
DROP TABLE IF EXISTS post_comments CASCADE;
DROP TABLE IF EXISTS user_location CASCADE;
DROP TABLE IF EXISTS neighbor_schedule CASCADE;
DROP TABLE IF EXISTS plaza CASCADE;
DROP TABLE IF EXISTS search_Together CASCADE;
DROP TABLE IF EXISTS record CASCADE;
DROP TABLE IF EXISTS report CASCADE;
DROP TABLE IF EXISTS period CASCADE;
DROP TABLE IF EXISTS missing_post CASCADE;
DROP TABLE IF EXISTS post CASCADE;
DROP TABLE IF EXISTS route CASCADE;
DROP TABLE IF EXISTS schedule_location CASCADE;
DROP TABLE IF EXISTS schedule CASCADE;
DROP TABLE IF EXISTS safe_zone CASCADE;
DROP TABLE IF EXISTS guardian_patient_connection CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS role CASCADE;

-- === 역할(role) 테이블 ===
CREATE TABLE role (
    role_no SERIAL PRIMARY KEY,
    role_name VARCHAR(50) NOT NULL
);

INSERT INTO role (role_name) VALUES 
    ('보호자'),
    ('환자'),
    ('구독자'),
    ('이웃');

-- === 유저(users) 테이블 ===
CREATE TABLE users (
    user_no SERIAL PRIMARY KEY,
    user_id VARCHAR(50) UNIQUE NOT NULL,
    user_pw VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    birth_date DATE,
    phone_number VARCHAR(20),
    invitation_code VARCHAR(8) UNIQUE,
    subscription_status INTEGER DEFAULT 0 CHECK (subscription_status IN (0,1)),
    user_status INTEGER DEFAULT 0 CHECK (user_status IN (0,1)),
    profile_photo TEXT,
    role_no INTEGER NOT NULL,
    FOREIGN KEY (role_no) REFERENCES role(role_no) ON DELETE RESTRICT
);

CREATE INDEX idx_users_invitation_code ON users(invitation_code);
CREATE INDEX idx_users_role_no ON users(role_no);


--보호자환자 연결테이블--
-------------------------------------------------
CREATE TABLE guardian_patient_connection (
    connection_no   SERIAL PRIMARY KEY,
    patient_no      INTEGER NOT NULL,
    guardian1_no    INTEGER NOT NULL,
    guardian2_no    INTEGER,
    guardian3_no    INTEGER,
   subscribe_starttime TIMESTAMPTZ, -- 구독 시작 시간
    subscribe_endtime TIMESTAMPTZ,   -- 구독 만료 시각

    FOREIGN KEY (patient_no)   REFERENCES users(user_no) ON DELETE CASCADE,
    FOREIGN KEY (guardian1_no) REFERENCES users(user_no) ON DELETE RESTRICT,
    FOREIGN KEY (guardian2_no) REFERENCES users(user_no) ON DELETE SET NULL,
    FOREIGN KEY (guardian3_no) REFERENCES users(user_no) ON DELETE SET NULL,

    UNIQUE(patient_no),

    CHECK (guardian1_no <> patient_no),
    CHECK (guardian2_no IS NULL OR guardian2_no <> patient_no),
    CHECK (guardian3_no IS NULL OR guardian3_no <> patient_no),

    CHECK (guardian2_no IS NULL OR guardian2_no IS DISTINCT FROM guardian1_no),
    CHECK (guardian3_no IS NULL OR guardian3_no IS DISTINCT FROM guardian1_no),
    CHECK (guardian2_no IS NULL OR guardian3_no IS NULL OR guardian2_no IS DISTINCT FROM guardian3_no)
);


CREATE INDEX IF NOT EXISTS idx_connection_subscribe_endtime
  ON guardian_patient_connection(subscribe_endtime);

CREATE INDEX IF NOT EXISTS idx_connection_patient
  ON guardian_patient_connection(patient_no);

-- 중복 인덱스 제거: UNIQUE 인덱스가 조회 성능도 제공하므로 일반 인덱스 제거
-- CREATE INDEX IF NOT EXISTS idx_connection_guardian1
--   ON guardian_patient_connection(guardian1_no);

CREATE UNIQUE INDEX IF NOT EXISTS uq_gpc_guardian1
  ON guardian_patient_connection(guardian1_no) WHERE guardian1_no IS NOT NULL;

CREATE UNIQUE INDEX IF NOT EXISTS uq_gpc_guardian2
  ON guardian_patient_connection(guardian2_no) WHERE guardian2_no IS NOT NULL;

CREATE UNIQUE INDEX IF NOT EXISTS uq_gpc_guardian3
  ON guardian_patient_connection(guardian3_no) WHERE guardian3_no IS NOT NULL;
-----------------------------------------------------


-- === 안심존(safe_zone) 테이블 ===
CREATE TABLE safe_zone (
    safe_zone_no SERIAL PRIMARY KEY,
    zone_type VARCHAR(20) NOT NULL CHECK (zone_type IN ('기본형','경로형','만남의 광장')),
    boundary_coordinates JSON NOT NULL,
    user_no INTEGER NOT NULL,
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_safe_zone_user ON safe_zone(user_no);
CREATE INDEX idx_safe_zone_type ON safe_zone(zone_type);

-- === 일정(schedule) 테이블 ===
-- [수정] CHECK 제약 개선: NULL 값 안전하게 처리
CREATE TABLE schedule (
    schedule_no SERIAL PRIMARY KEY,
    schedule_title VARCHAR(200) NOT NULL,
    content TEXT,
    schedule_date DATE NOT NULL,
    start_time TIME(0),
    end_time TIME(0),
    user_no INTEGER NOT NULL,
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE,
    CHECK ((start_time IS NULL) OR (end_time IS NULL) OR (end_time > start_time))
);

CREATE INDEX idx_schedule_user ON schedule(user_no);
CREATE INDEX idx_schedule_date ON schedule(schedule_date);

-- === 일정 위치(schedule_location) 테이블 ===
CREATE TABLE schedule_location (
    location_no SERIAL PRIMARY KEY,
    location_name VARCHAR(200) NOT NULL,
    latitude DECIMAL(10,8) NOT NULL CHECK (latitude BETWEEN -90 AND 90),
    longitude DECIMAL(11,8) NOT NULL CHECK (longitude BETWEEN -180 AND 180),
    sequence_order INTEGER NOT NULL CHECK (sequence_order > 0),
    schedule_no INTEGER NOT NULL,
    FOREIGN KEY (schedule_no) REFERENCES schedule(schedule_no) ON DELETE CASCADE
);

CREATE INDEX idx_location_schedule ON schedule_location(schedule_no);
CREATE INDEX idx_location_sequence ON schedule_location(schedule_no, sequence_order);

-- === 경로(route) 테이블 ===
CREATE TABLE route (
    route_no SERIAL PRIMARY KEY,
    route_coordinates JSON NOT NULL,
    buffer_coordinates JSON NOT NULL,
    schedule_no INTEGER NOT NULL,
    FOREIGN KEY (schedule_no) REFERENCES schedule(schedule_no) ON DELETE CASCADE,
    UNIQUE(schedule_no)
);

CREATE INDEX idx_route_schedule ON route(schedule_no);

-- === 게시물(post) 테이블 ===
-- [수정] user_id 컬럼명을 user_no로 변경하여 FK 일관성 확보
CREATE TABLE post (
    post_id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    user_no INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    content TEXT NOT NULL,
   notice_check VARCHAR(20),
    view_count INT DEFAULT 0,
    image_path VARCHAR(255),
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_post_user_no ON post(user_no);
CREATE INDEX idx_post_created_at ON post(created_at);
CREATE INDEX idx_post_view_count ON post(view_count);

CREATE TABLE post_comments (
    comment_id SERIAL PRIMARY KEY,
    post_id INTEGER NOT NULL,
    user_no INTEGER NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) 
        REFERENCES post(post_id) ON DELETE CASCADE,
    FOREIGN KEY (user_no) 
        REFERENCES users(user_no) ON DELETE SET NULL
);

-- === 실종자 게시물(missing_post) 테이블 ===
CREATE TABLE missing_post (
    missing_post_id SERIAL PRIMARY KEY,
    patient_user_no INTEGER NOT NULL,
    reporter_user_no INTEGER NOT NULL,
    photo_path VARCHAR(255),
    description TEXT,
    reported_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) NOT NULL DEFAULT '실종',
    FOREIGN KEY (patient_user_no) REFERENCES users(user_no) ON DELETE CASCADE,
    FOREIGN KEY (reporter_user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_missing_post_patient ON missing_post(patient_user_no);
CREATE INDEX idx_missing_post_reporter ON missing_post(reporter_user_no);
CREATE INDEX idx_missing_post_reported_at ON missing_post(reported_at);
CREATE INDEX idx_missing_post_status ON missing_post(status);

-- === 함께 찾기(search_Together) 테이블 ===
-- [수정] user_id 컬럼명을 user_no로 변경하여 FK 일관성 확보
CREATE TABLE search_Together (
    missing_post_id INTEGER NOT NULL,
    user_no INTEGER NOT NULL,
    PRIMARY KEY (missing_post_id, user_no),
    FOREIGN KEY (missing_post_id) REFERENCES missing_post(missing_post_id) ON DELETE CASCADE,
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_search_together_missing_post ON search_Together(missing_post_id);
CREATE INDEX idx_search_together_user ON search_Together(user_no);

-- === 실종 발생시 알람 테이블 ===
-- [수정] user_id 컬럼명을 user_no로 변경하여 FK 일관성 확보
CREATE TABLE missing_alert_check (
    user_no INTEGER NOT NULL,
    missing_post_id INTEGER NOT NULL,
    
    -- 한 사용자가 한 알림을 한 번만 확인할 수 있도록 PK 설정
    PRIMARY KEY (user_no, missing_post_id), 
    
    -- 실종 신고가 삭제되면 이 기록도 자동 삭제
    FOREIGN KEY (missing_post_id) REFERENCES missing_post(missing_post_id) ON DELETE CASCADE,
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_missing_alert_user ON missing_alert_check(user_no);
CREATE INDEX idx_missing_alert_post ON missing_alert_check(missing_post_id);

-- === 제보하기 (sighting_report) 테이블 ===
CREATE TABLE sighting_report (
    sighting_report_id SERIAL PRIMARY KEY,
    missing_post_id INTEGER NOT NULL,
    user_no INTEGER NOT NULL,
    content TEXT NOT NULL,
    image_path VARCHAR(255),
    latitude DOUBLE PRECISION,
    longitude DOUBLE PRECISION,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (missing_post_id) 
        REFERENCES missing_post(missing_post_id) ON DELETE CASCADE,
    FOREIGN KEY (user_no) 
        REFERENCES users(user_no) ON DELETE SET NULL
);

CREATE INDEX idx_sighting_report_missing_post ON sighting_report(missing_post_id);
CREATE INDEX idx_sighting_report_user ON sighting_report(user_no);


-- === 제보 댓글 (sighting_report_comments) 테이블 ===
CREATE TABLE sighting_report_comments (
    comment_id SERIAL PRIMARY KEY,
    sighting_report_id INTEGER NOT NULL,
    user_no INTEGER NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sighting_report_id) 
        REFERENCES sighting_report(sighting_report_id) ON DELETE CASCADE,
    FOREIGN KEY (user_no) 
        REFERENCES users(user_no) ON DELETE SET NULL
);

CREATE INDEX idx_sighting_report_comments_report_id ON sighting_report_comments(sighting_report_id);
CREATE INDEX idx_sighting_report_comments_user_no ON sighting_report_comments(user_no);

-- === 이웃 일정(neighbor_schedule) 테이블 ===
CREATE TABLE neighbor_schedule (
    schedule_no SERIAL PRIMARY KEY,
    schedule_title VARCHAR(200) NOT NULL,
    content TEXT,
    schedule_date DATE NOT NULL,
    user_no INTEGER NOT NULL,  -- 이웃 사용자 ID
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_neighbor_schedule_user ON neighbor_schedule(user_no);
CREATE INDEX idx_neighbor_schedule_date ON neighbor_schedule(schedule_date);

-- === 만남의 광장(plaza) 테이블 ===
CREATE TABLE plaza (
    plaza_no SERIAL PRIMARY KEY,
    plaza_name VARCHAR(200) NOT NULL,
   member_name VARCHAR(200) NOT NULL CHECK (member_name IN ('방장','이웃')),
    user_no INTEGER NOT NULL,  -- 이웃 사용자 ID
    FOREIGN KEY (user_no) REFERENCES users(user_no) ON DELETE CASCADE
);

CREATE INDEX idx_plaza_plaza_no ON plaza(plaza_no);
CREATE INDEX idx_plaza_plaza_name ON plaza(plaza_name);
CREATE INDEX idx_plaza_user ON plaza(user_no);

-- === period, report, record 테이블 ===

CREATE TABLE IF NOT EXISTS period (
  period_id    SERIAL PRIMARY KEY,
  period_type  VARCHAR(16) NOT NULL,          -- 'year' | 'month' | 'week' | 'custom'
  period_key   VARCHAR(32) NOT NULL,          -- 예: 2024 / 2024-10 / 2024-W43
  start_date   DATE NOT NULL,
  end_date     DATE NOT NULL,
  created_at   TIMESTAMPTZ DEFAULT NOW(),
  updated_at   TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT uq_period_type_key UNIQUE (period_type, period_key),
  CONSTRAINT ck_period_type_lower CHECK (period_type IN ('year','month','week','custom'))  -- [추가] 타입 고정(소문자)
);

-- (선택) 탐색 성능용 보조 인덱스
CREATE INDEX IF NOT EXISTS idx_period_type_key ON period (period_type, period_key);

-- [추가] period_type을 항상 소문자로 맞추는 정규화 트리거
CREATE OR REPLACE FUNCTION trg_lower_period_type() RETURNS trigger AS $$
BEGIN
  IF NEW.period_type IS NOT NULL THEN
    NEW.period_type := lower(NEW.period_type);
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tg_period_lower ON period;
CREATE TRIGGER tg_period_lower
BEFORE INSERT OR UPDATE ON period
FOR EACH ROW EXECUTE FUNCTION trg_lower_period_type();


CREATE TABLE IF NOT EXISTS report (
  report_id     SERIAL PRIMARY KEY,
  period_id     INT NOT NULL,
  patient_id    INT NOT NULL,
  content       TEXT NOT NULL,

  -- 메타
  period_type   VARCHAR(16) NOT NULL DEFAULT 'year',   -- 조회/캐시용(동일 값 중복 보관)
  period_key    VARCHAR(32) NOT NULL DEFAULT '',
  version       INT NOT NULL DEFAULT 1,
  generated_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  generated_by  VARCHAR(50) DEFAULT 'gemini',
  locked        BOOLEAN NOT NULL DEFAULT TRUE,
  source_hash   TEXT,

  metrics       JSONB NOT NULL DEFAULT '{}'::jsonb,
  sections      JSONB NOT NULL DEFAULT '{}'::jsonb,
  chart_prefs   JSONB NOT NULL DEFAULT '{}'::jsonb,

  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT fk_report_period  FOREIGN KEY(period_id)  REFERENCES period(period_id) ON DELETE CASCADE,
  CONSTRAINT fk_report_patient FOREIGN KEY(patient_id) REFERENCES users(user_no)    ON DELETE CASCADE
);

-- 같은 환자 X 같은 기간(type+key)은 1건 보장
CREATE UNIQUE INDEX IF NOT EXISTS uq_report_patient_tk
  ON report (patient_id, period_type, period_key);

-- [추가-성능] period 조인/탐색 가속
CREATE INDEX IF NOT EXISTS idx_report_period ON report(period_id);

-- [추가-성능] 환자별 최신 보고서 빠른 조회
CREATE INDEX IF NOT EXISTS idx_report_patient_time ON report(patient_id, generated_at DESC);

-- [추가] report.period_type도 소문자 정규화
DROP TRIGGER IF EXISTS tg_report_lower ON report;
CREATE TRIGGER tg_report_lower
BEFORE INSERT OR UPDATE ON report
FOR EACH ROW EXECUTE FUNCTION trg_lower_period_type();


-- === record 테이블 ===
-- [수정] user_id 컬럼명을 user_no로 변경하여 FK 일관성 확보
CREATE TABLE IF NOT EXISTS record (
  record_id   SERIAL PRIMARY KEY,
  user_no     INT NOT NULL,
  record_date DATE NOT NULL,
  content     JSONB NOT NULL,
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  updated_at  TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT fk_record_user FOREIGN KEY(user_no) REFERENCES users(user_no) ON DELETE CASCADE,
  CONSTRAINT uq_record_user_date UNIQUE (user_no, record_date)
);

-- 주형 user_location 테이블 추가
CREATE TABLE IF NOT EXISTS user_location (
  location_no SERIAL PRIMARY KEY,
  user_no INT NOT NULL,
  latitude DECIMAL(10,8) NOT NULL CHECK (latitude BETWEEN -90 AND 90),
  longitude DECIMAL(11,8) NOT NULL CHECK (longitude BETWEEN -180 AND 180),
  record_time TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT fk_user_no FOREIGN KEY(user_no) REFERENCES users(user_no) ON DELETE CASCADE
);
-- 주형 수정 끝

-- updated_at 자동 갱신 트리거 (period / report / record 모두 적용)
CREATE OR REPLACE FUNCTION trg_touch_updated_at() RETURNS trigger AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tg_period_touch ON period;
CREATE TRIGGER tg_period_touch
BEFORE UPDATE ON period
FOR EACH ROW EXECUTE FUNCTION trg_touch_updated_at();

DROP TRIGGER IF EXISTS tg_report_touch ON report;
CREATE TRIGGER tg_report_touch
BEFORE UPDATE ON report
FOR EACH ROW EXECUTE FUNCTION trg_touch_updated_at();

DROP TRIGGER IF EXISTS tg_record_touch ON record;
CREATE TRIGGER tg_record_touch
BEFORE UPDATE ON record
FOR EACH ROW EXECUTE FUNCTION trg_touch_updated_at();


-----------------------------------------------------------------



-- === 샘플 데이터 삽입 ===
-- 1~4번: subscription_status = 1 (구독 상태)
-- 5~6번: subscription_status = 0 (미구독 상태)
-- 4번, 6번: 환자이므로 invitation_code 포함
-- 7번: 이웃
INSERT INTO users (user_id, user_pw, name, birth_date, phone_number, invitation_code, subscription_status, user_status, role_no) VALUES
('1', '$2a$10$xq0wJw38x3VbFJgbWf1Ms.4nIHMwiedUyK8Psi50KQegFACEHZybC', '이재빈', '1965-03-15', '010-1234-5678', NULL, 1, 0, 1),
('2', '$2a$10$AfUiLvowiy9siSIXARErweg6HJBDycKcjJJwc8z7ZCY4vac3XQ.Cy', '이정민', '1968-07-22', '010-2345-6789', NULL, 1, 0, 1),
('3', '$2a$10$1.0xJFOsl6Nwc/bKBZRCeuPCbPfbFhFreyiIby2fYlH2wVaaxt8V.', '박지겸', '1970-11-08', '010-3456-7890', NULL, 1, 0, 1),
('4', '$2a$10$eVDtK3awsigHOnLBQnpQvu/hI9VjZDTPFdkP4M3cbtXIKuHVk0dA2', '서지현', '1947-05-30', '010-4567-8901', 'K7M2pQ9x', 1, 1, 3),
('5', '$2a$10$VouPFhIzSF0KidzGbEeu1e1AR7TtHt77VmdqcWXzhATMZFpL1nREK', '이주형', '1972-09-18', '010-5678-9012', NULL, 0, 0, 1),
('6', '$2a$10$J4wpcY/coYYLf1iTEvhVauhQtfUpMnOybtKV4ywTzvI5o2JYvxF3i', '김병욱', '1955-02-14', '010-6789-0123', 'A8nB5vL1', 0, 0, 2),
('7', '$2a$10$1M.O5GVTBy4.bzk7OdGrGeWplqd1wz5mIosWwbA3HBbTb8qhkeXy.', '고영준', '1971-01-07', '010-5647-5416', NULL, 0, 0, 4);

-- [수정] post 테이블 INSERT - user_no로 변경
INSERT INTO post (title, user_no, content, view_count, image_path) VALUES
(
    '치매에 좋은 음식 (DB 테스트)',
    1,
    '뇌 건강에 좋은 음식으로는 등 푸른 생선, 견과류, 베리류 등이 있습니다.',
    14,
    '/images/sample_food_image.jpg'
);

INSERT INTO missing_post (reporter_user_no, patient_user_no, photo_path, description) VALUES
(
    1,
    4,
    '/images/missing_grandma.jpg',
    '성함: 서지현 (78세)\n실종일시: 2025년 10월 9일 오전 9시경\n실종장소: 안산시 단원구 중앙동 인근\n인상착의: 연한 회색 가디건, 검정색 바지, 흰색 운동화 착용.'
);

-- [수정] search_Together INSERT - user_no로 변경
INSERT INTO search_Together (missing_post_id, user_no) VALUES
(1, 2);

-- 4번 서지현(구독자): 보호자 3명 연결 가능
-- 6번 김병욱(환자): 보호자 1명만 연결 가능
INSERT INTO guardian_patient_connection (patient_no, guardian1_no, guardian2_no, guardian3_no) VALUES
(4, 1, 2, 3),
(6, 5, NULL, NULL);




SELECT setseed(0.42);  -- 랜덤 시드(옵션)

-- 4번 환자(서지현) 기록 생성
WITH params AS (
  SELECT
    4::int           AS user_no,        -- 서지현(환자)
    DATE '2024-01-01' AS start_date,
    DATE '2025-10-27' AS end_date
),
dates AS (
  SELECT p.user_no, gs::date AS record_date
  FROM params p
  JOIN generate_series((SELECT start_date FROM params),
                       (SELECT end_date   FROM params),
                       INTERVAL '1 day') gs ON TRUE
)
INSERT INTO record (user_no, record_date, content)
SELECT
  d.user_no,
  d.record_date,
  jsonb_build_object(
    'act', jsonb_build_object(
      'fall',        (random() < 0.05),
      'dress',       (ARRAY['혼자','도움 필요'])[1 + floor(random()*2)],
      'toilet',      (ARRAY['혼자','도움 필요'])[1 + floor(random()*2)],
      'lostWay',     (random() < 0.03),
      'knowDate',    (random() >= 0.10),
      'missAppt',    (ARRAY['0','1–2회','3회 이상'])[1 + floor(random()*3)],
      'appliance',   (ARRAY['문제 없음','주의 필요'])[1 + floor(random()*2)],
      'lostItems',   (ARRAY['0','1–2회','3회 이상'])[1 + floor(random()*3)]
    ),
    'med', jsonb_build_object(
      'medMiss',        to_jsonb(ARRAY(
                           SELECT x FROM unnest(ARRAY['아침','점심','저녁']) x
                           WHERE random() < 0.10
                         )),
      'extraMed',       (random() < 0.08),
      'extraMedDetail', CASE WHEN random() < 0.08 THEN '진통제' ELSE '' END
    ),
    'feel', jsonb_build_object(
      'apathy',       (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'anxiety',      (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'depress',      (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'irritate',     (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'moodScore',    (1 + floor(random()*5))::int,
      'conversation', (ARRAY['적극','보통','소극'])[1 + floor(random()*3)]
    ),
    'meal', jsonb_build_object(
      'snack',    (random() < 0.60),
      'water',    (ARRAY['충분','보통','적음'])[1 + floor(random()*3)],
      'skipMeal', (ARRAY['아침','점심','저녁','없음'])[1 + floor(random()*4)]
    ),
    'note', jsonb_build_object(
      'pain',            (random() < 0.10),
      'temp',            (random() < 0.10),
      'support',         (random() < 0.15),
      'emergency',       (random() < 0.02),
      'repeatAct',       (random() < 0.08),
      'painDetail',      '',
      'tempDetail',      '',
      'nightWander',     (random() < 0.12),
      'supportDetail',   '',
      'emergencyDetail', ''
    )
  )
FROM dates d
ON CONFLICT (user_no, record_date) DO NOTHING;

-- 6번 환자(김병욱) 기록 생성
WITH params AS (
  SELECT
    6::int           AS user_no,        -- 김병욱(환자)
    DATE '2024-01-01' AS start_date,
    DATE '2025-10-27' AS end_date
),
dates AS (
  SELECT p.user_no, gs::date AS record_date
  FROM params p
  JOIN generate_series((SELECT start_date FROM params),
                       (SELECT end_date   FROM params),
                       INTERVAL '1 day') gs ON TRUE
)
INSERT INTO record (user_no, record_date, content)
SELECT
  d.user_no,
  d.record_date,
  jsonb_build_object(
    'act', jsonb_build_object(
      'fall',        (random() < 0.05),
      'dress',       (ARRAY['혼자','도움 필요'])[1 + floor(random()*2)],
      'toilet',      (ARRAY['혼자','도움 필요'])[1 + floor(random()*2)],
      'lostWay',     (random() < 0.03),
      'knowDate',    (random() >= 0.10),
      'missAppt',    (ARRAY['0','1–2회','3회 이상'])[1 + floor(random()*3)],
      'appliance',   (ARRAY['문제 없음','주의 필요'])[1 + floor(random()*2)],
      'lostItems',   (ARRAY['0','1–2회','3회 이상'])[1 + floor(random()*3)]
    ),
    'med', jsonb_build_object(
      'medMiss',        to_jsonb(ARRAY(
                           SELECT x FROM unnest(ARRAY['아침','점심','저녁']) x
                           WHERE random() < 0.10
                         )),
      'extraMed',       (random() < 0.08),
      'extraMedDetail', CASE WHEN random() < 0.08 THEN '진통제' ELSE '' END
    ),
    'feel', jsonb_build_object(
      'apathy',       (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'anxiety',      (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'depress',      (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'irritate',     (ARRAY['없음','경미','심함'])[1 + floor(random()*3)],
      'moodScore',    (1 + floor(random()*5))::int,
      'conversation', (ARRAY['적극','보통','소극'])[1 + floor(random()*3)]
    ),
    'meal', jsonb_build_object(
      'snack',    (random() < 0.60),
      'water',    (ARRAY['충분','보통','적음'])[1 + floor(random()*3)],
      'skipMeal', (ARRAY['아침','점심','저녁','없음'])[1 + floor(random()*4)]
    ),
    'note', jsonb_build_object(
      'pain',            (random() < 0.10),
      'temp',            (random() < 0.10),
      'support',         (random() < 0.15),
      'emergency',       (random() < 0.02),
      'repeatAct',       (random() < 0.08),
      'painDetail',      '',
      'tempDetail',      '',
      'nightWander',     (random() < 0.12),
      'supportDetail',   '',
      'emergencyDetail', ''
    )
  )
FROM dates d
ON CONFLICT (user_no, record_date) DO NOTHING;

insert into plaza(plaza_no, plaza_name, member_name, user_no) values
(1, '경1', '방장', 7);

-- user_location 테이블에 CSV 데이터 삽입
COPY user_location(user_no, latitude, longitude, record_time)
FROM 'C:\final-project\gps_trajectory_1year.csv'
DELIMITER ','
CSV HEADER;