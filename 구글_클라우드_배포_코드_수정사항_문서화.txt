# 구글 클라우드 런 배포를 위한 코드 수정사항 문서화
# 작성일: 2025년 11월 21일
# 작성자: AI Assistant
# 목적: 로컬 개발 환경에서 2개월간 쌓인 하드코딩 문제들을 Google Cloud Run 배포용으로 수정
# 대상: 팀원 공유용 문서

================================================================================
1. OVERVIEW (전체 개요)
================================================================================

■ 수정 대상: Spring Boot 백엔드, FastAPI AI 서비스, Vue.js 프론트엔드
■ 수정 목적: localhost 하드코딩 제거, 환경변수 적용, 컨테이너화 준비
■ 총 수정 파일 수: 45개 이상
■ 주요 변경사항:
  - 하드코딩된 localhost URL → 환경변수
  - API 키 하드코딩 → 환경변수
  - 데이터베이스 연결 정보 → 환경변수
  - Docker 컨테이너화 설정 추가

================================================================================
2. SPRING BOOT 백엔드 수정사항 (backend/)
================================================================================

2.1 application.properties
■ 파일 위치: backend/src/main/resources/application.properties
■ 수정 목적: 환경변수 기반 설정으로 변경

[변경 전]
spring.datasource.url=jdbc:postgresql://localhost:5432/finalproject
spring.datasource.username=postgres
spring.datasource.password=rootroot
tmap.api.key=3EkdQeGupP3Y0mJO1SuVC31mEYHXemG4hJMIET47

[변경 후]
spring.datasource.url=jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:finalproject}
spring.datasource.username=${DB_USER:postgres}
spring.datasource.password=${DB_PASSWORD:rootroot}
tmap.api.key=${TMAP_API_KEY:3EkdQeGupP3Y0mJO1SuVC31mEYHXemG4hJMIET47}

■ 추가 사항:
- HTTPS 설정 주석 처리 (Cloud Run에서 자동 HTTPS 제공)
- DOMAIN 환경변수 추가: DOMAIN=${DOMAIN:localhost:3000}

2.2 SecurityConfig.java
■ 파일 위치: backend/src/main/java/lx/project/dementia_care/security/SecurityConfig.java
■ 수정 내용: 프론트엔드 도메인 기본값 변경

[변경 전]
@Value("${DOMAIN:localhost:5173}")
private String domain;

[변경 후]
@Value("${DOMAIN:localhost:3000}")
private String domain;

2.3 FileController.java
■ 파일 위치: backend/src/main/java/lx/project/dementia_care/controller/FileController.java
■ 수정 내용: 도메인 기본값 변경

[변경 전]
@Value("${DOMAIN:localhost:8080}")
private String domain;

[변경 후]
@Value("${DOMAIN:localhost:3000}")
private String domain;

2.4 GoogleAiClient.java
■ 파일 위치: backend/src/main/java/lx/project/dementia_care/config/GoogleAiClient.java
■ 수정 목적: Gemini API 키 하드코딩 제거 및 환경변수화

[변경 전]
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.client.SimpleClientHttpRequestFactory;

import java.util.List;
import java.util.Map;

@Component
public class GoogleAiClient {
	private static final String MODEL = "gemini-2.0-flash";
	private static final String BASE = "https://generativelanguage.googleapis.com";

	private String resolveApiKey() {
		return "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

	}

[변경 후]
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.client.SimpleClientHttpRequestFactory;

import java.util.List;
import java.util.Map;

@Component
public class GoogleAiClient {
	private static final String MODEL = "gemini-2.0-flash";
	private static final String BASE = "https://generativelanguage.googleapis.com";

	@Value("${GEMINI_API_KEY:#{null}}")
	private String geminiApiKey;

	private String resolveApiKey() {
		if (geminiApiKey != null && !geminiApiKey.trim().isEmpty()) {
			return geminiApiKey;
		}
		throw new IllegalStateException("GEMINI_API_KEY 환경변수가 설정되지 않았습니다.");

	}

================================================================================
3. FASTAPI AI 서비스 수정사항 (python/)
================================================================================

3.1 FastAPI_v2.py
■ 파일 위치: python/FastAPI_v2.py
■ 수정 목적: 환경변수 기반 설정으로 변경

[변경 전]
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
# ...
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://localhost:5173"],
    # ...
)
# ...
uvicorn.run(app, host="0.0.0.0", port=8000)

[변경 후]
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import os  # 추가됨
# ...
app.add_middleware(
    CORSMiddleware,
    allow_origins=[os.getenv("FRONTEND_URL", "https://localhost:3000")],
    # ...
)
# ...
uvicorn.run(app, host=os.getenv("HOST", "0.0.0.0"), port=int(os.getenv("PORT", "8000")))

================================================================================
4. VUE.JS 프론트엔드 수정사항 (frontend/)
================================================================================

4.1 vite.config.js
■ 파일 위치: frontend/vite.config.js
■ 수정 목적: API 프록시 설정을 환경변수화

[변경 전]
proxy: {
  '/api': {
    target: 'https://localhost:8080',
    // ...
  },
  '/NH/api': {
    target: 'https://localhost:8080',
    // ...
  },
}

[변경 후]
proxy: {
  '/api': {
    target: process.env.VITE_API_BASE_URL || 'https://localhost:8080',
    // ...
  },
  '/NH/api': {
    target: process.env.VITE_API_BASE_URL || 'https://localhost:8080',
    // ...
  },
}

4.2 Vue 컴포넌트 파일들 (총 15개 파일 수정)
■ 수정 대상 파일들:
- frontend/src/views/GD_ModifyInfo.vue
- frontend/src/views/DP_ModifyInfo.vue
- frontend/src/views/desktop/DesktopPredict.vue
- frontend/src/views/PredictLocation.vue
- frontend/src/views/JustPredictLocation.vue
- frontend/src/components/AgentSimulationModal.vue
- frontend/src/components/DesktopAgentSimulationModal.vue
- frontend/src/views/NoDataSimulation.vue
- frontend/src/views/PredictLocationBackup.vue
- frontend/src/App.vue

■ 주요 수정 패턴:
[변경 전]
const API_BASE = import.meta.env.VITE_API_BASE_URL || 'https://localhost:8080'
'http://localhost:8000/api/predict-destinations'
'http://localhost:8000/api/agent-simulation/run-all'

[변경 후]
const API_BASE = import.meta.env.VITE_API_BASE_URL || 'https://localhost:3000'
`${import.meta.env.VITE_FASTAPI_URL || 'http://localhost:8000'}/api/predict-destinations`
`${import.meta.env.VITE_FASTAPI_URL || 'http://localhost:8000'}/api/agent-simulation/run-all`

4.3 카카오 지도 API 키 환경변수화
■ 수정 파일: 17개 Vue 파일 전체
■ 주요 수정 파일들:
  - BasicSafeZoneRadiusView.vue, SearchRouteView.vue, heartCare.vue
  - PlazaDetail.vue, HospitalCare.vue, DesktopMypageSafezoneRadius.vue
  - DesktopMypageSafezone.vue, GeoFencingView.vue, CreatePlaza.vue
  - BasicSafeZoneLocationView.vue, DP_schedule.vue, PredictLocationBackup.vue
  - NoDataSimulation.vue, AgentSimulationModal.vue, DesktopAgentSimulationModal.vue
  - PredictLocation.vue, JustPredictLocation.vue

■ 수정 내용:
[변경 전]
const KAKAO_JS_KEY = '52b0ab3fbb35c5b7adc31c9772065891'
// 또는
const KAKAO_JS_KEY = '7e0332c38832a4584b3335bed6ae30d8'

[변경 후]
const KAKAO_JS_KEY = import.meta.env.VITE_KAKAO_JS_KEY || '52b0ab3fbb35c5b7adc31c9772065891'
// 또는
const KAKAO_JS_KEY = import.meta.env.VITE_KAKAO_JS_KEY || '7e0332c38832a4584b3335bed6ae30d8'

================================================================================
5. 새로 생성된 파일들
================================================================================

5.1 Backend Dockerfile
■ 파일 위치: backend/Dockerfile
■ 목적: Spring Boot 컨테이너화
■ 내용:
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/dementia-care-0.0.1-SNAPSHOT.war app.war
EXPOSE 8080
CMD ["java", "-jar", "app.war"]

5.2 Backend .dockerignore
■ 파일 위치: backend/.dockerignore
■ 목적: 불필요한 파일들 Docker 이미지에서 제외
■ 내용:
target/
*.log
*.tmp
.git/
.gitignore
README.md
.env

5.3 FastAPI Dockerfile
■ 파일 위치: python/Dockerfile
■ 목적: Python AI 서비스 컨테이너화
■ 내용:
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY FastAPI_v2.py .
COPY *.csv .
EXPOSE 8000
CMD ["python", "FastAPI_v2.py"]

5.4 Frontend Dockerfile
■ 파일 위치: frontend/Dockerfile
■ 목적: Vue.js 빌드 및 Nginx 서빙
■ 내용:
FROM node:18-alpine as build
# ... 빌드 과정 ...
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

5.5 환경변수 예시 파일
■ 파일 위치: env-example.txt
■ 목적: 배포시 필요한 환경변수들 정리
■ 주요 환경변수:
- DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD (데이터베이스)
- TMAP_API_KEY, KAKAO_JS_KEY, GEMINI_API_KEY (API 키)
- DOMAIN (프론트엔드 도메인)
- FRONTEND_URL, HOST, PORT (FastAPI)
- VITE_API_BASE_URL, VITE_FASTAPI_URL (Vue.js)

================================================================================
6. 수정 원칙 및 배경
================================================================================

6.1 수정 원칙
■ 기존 로컬 개발 환경 유지: 환경변수가 없으면 기존 localhost 값 사용
■ 점진적 마이그레이션 가능: 한 번에 모든 값 변경 가능
■ 보안 강화: API 키 하드코딩 제거
■ 배포 유연성: 환경별 설정 분리

6.2 주요 배경
■ 로컬 개발 2개월간 쌓인 하드코딩 문제 해결
■ Google Cloud Run 서버리스 환경에 최적화
■ 컨테이너 기반 배포를 위한 Docker 설정
■ 프로덕션 환경의 보안 및 유지보수성 향상

================================================================================
7. 배포시 주의사항
================================================================================

7.1 환경변수 설정
■ 각 Cloud Run 서비스마다 환경변수 개별 설정 필요
■ API 키는 Google Cloud Secret Manager 사용 권장
■ 데이터베이스 연결 정보는 Cloud SQL 연결 정보 사용
■ Spring Boot 서비스에는 GEMINI_API_KEY, TMAP_API_KEY 설정 필요

7.2 서비스 간 통신
■ 프론트엔드 → 백엔드: VITE_API_BASE_URL
■ 프론트엔드 → FastAPI: VITE_FASTAPI_URL
■ 백엔드 → FastAPI: 직접 HTTP 호출

7.3 CORS 설정
■ FastAPI의 FRONTEND_URL 환경변수에 프론트엔드 URL 설정
■ Spring Boot CORS 설정 확인 필요

================================================================================
8. 검증 방법
================================================================================

8.1 로컬 테스트
■ 환경변수 없이 실행: 기존 로컬 개발 동작 확인
■ 환경변수 설정 후 실행: 클라우드 환경 시뮬레이션

8.2 Docker 빌드 테스트
■ 각 서비스별 Docker 이미지 빌드 및 실행 확인
■ 환경변수 전달 확인

8.3 Cloud Run 배포 전 확인사항
■ 모든 환경변수 값 준비
■ 데이터베이스 연결 확인
■ API 키 유효성 확인

================================================================================
9. 롤백 계획
================================================================================

■ 환경변수 문제 발생시: 기본값으로 자동 폴백
■ 배포 실패시: 이전 버전으로 즉시 롤백 가능
■ 데이터 손실 방지: 데이터베이스 백업 필수

================================================================================
10. 향후 개선사항
================================================================================

■ Google Cloud Secret Manager 도입으로 API 키 보안 강화
■ 환경별 설정 파일 분리 (dev/staging/prod)
■ CI/CD 파이프라인 구축으로 자동화 배포
■ 모니터링 및 로깅 시스템 구축

================================================================================
문서 끝
================================================================================
